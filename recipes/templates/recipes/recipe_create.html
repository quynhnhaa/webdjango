{% extends 'homepage/base.html' %}
{% load static %}

{% block cssblock %}
    <!-- Title -->
    <title>Viết món mới</title>
    <!-- Favicon -->
    <link rel="icon" href="img/core-img/favicon.ico">
    <link rel="stylesheet" href="{% static 'homepage/style.css' %}">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <script>
        function addIngredient() {
            const container = document.getElementById('ingredients-container');
            const newInput = document.createElement('div');
            newInput.className = 'mb-2 flex items-center';
            newInput.innerHTML = `
                <input class="w-1/3 p-2 border rounded mr-2" type="text" name="ingredient_quantity[]" placeholder="Số lượng"/>
                <input class="w-2/3 p-2 border rounded" name="ingredient_name[]" list="ingredients" placeholder="Chọn hoặc nhập nguyên liệu"/>
                <button class="ml-2 text-red-500" onclick="removeElement(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            container.appendChild(newInput);
        }
    
        function addStep() {
            const container = document.getElementById('steps-container');
            const stepCount = container.children.length + 1;
            const newStep = document.createElement('div');
            newStep.className = 'mb-2 flex items-start';
            newStep.innerHTML = `
                <span class="bg-gray-200 text-gray-600 rounded-full w-6 h-6 flex items-center justify-center mr-2">${stepCount}</span>
                <div class="flex-1">
                    <input class="w-full p-2 border rounded mb-2" type="text" name="step_description[]" placeholder="Nhập bước"/>
                </div>
                <button class="ml-2 text-red-500" onclick="removeElement(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            container.appendChild(newStep);
        }
    
        function removeElement(button) {
            button.parentElement.remove();
        }
    </script>
{% endblock %}

    <!--Navbar-->

    {% block content %}
        <!-- ##### Breadcumb Area Start ##### -->
        <div class="breadcumb-area bg-img bg-overlay" style="background-image: url({%static 'homepage/img/bg-img/breadcumb3.jpg' %});">
            <div class="container h-100">
                <div class="row h-100 align-items-center">
                    <div class="col-12">
                        <div class="breadcumb-text text-center">
                            <h2>Sáng Tạo Món Ngon</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
        <!-- ##### Breadcumb Area End ##### -->
        <div class="container mx-auto pt-10 pl-40 pr-40" style="margin-bottom: 60px;">
            <form method="POST" enctype="multipart/form-data" id="recipeForm">
                {% csrf_token %}
                <div class="flex justify-between items-center mb-4">
                    <button class="text-gray-500"></button>
                    <div class="flex space-x-2">
                        <button type="button" class="bg-yellow-100 text-yellow-500 px-4 py-2 rounded border border-yellow- ;border-yellow-500">
                            Xóa
                        </button>
                        <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded">
                            Lưu và Đóng
                        </button>
                    </div>
                </div>
                <div id="error-messages" class="bg-red-100 text-red-700 p-4 rounded mb-4 hidden">
                    <p>Vui lòng sửa các lỗi sau:</p>
                    <ul id="error-list"></ul>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-100 p-4 rounded flex flex-col items-center justify-center">
                        <input type="file" name="image" id="imageUpload" aria-label="Bạn đã đăng hình món mình nấu ở đây chưa?" accept="image/*">
                        <img id="previewImage" class="mt-3 rounded-lg hidden" style="max-width: 100%; height: auto;">
                        <p class="text-center">
                            Bạn đã đăng hình món mình nấu ở đây chưa? Chia sẻ với mọi người thành phẩm nấu nướng của bạn nào!
                        </p>
                    </div>
                    <div class="col-span-2">
                        <div class="bg-gray-100 p-4 rounded mb-4">
                            <h1 class="text-xl font-bold">
                                <input type="text" name="name" class="form-control" id="name" placeholder="Tên món: Món canh bí ngon nhất nhà mình">
                            </h1>
                            <div class="flex items-center mt-2">
                                <img alt="User avatar" class="rounded-full mr-2" height="40" src="https://storage.googleapis.com/a1aa/image/SoXCrjwhKpJ8PygeY7t827baz9mahj3WkX540F8mQhk.jpg" width="40"/>
                                <div>
                                    <p class="font-semibold">Bạn</p>
                                </div>
                            </div>
                            <p class="mt-4">
                                <input type="text" name="description" class="form-control" id="description" placeholder="Hãy mô tả món ăn của bạn">
                            </p>
                            
                        </div>
                        <div class="mt-4 mb-6">
                            <h2 class="text-lg font-bold mb-2">Danh mục</h2>
                            <input class="w-full p-2 border rounded" name="category" list="categorys" placeholder="Chọn hoặc nhập danh mục"/>
                            <datalist id="categorys">
                                {% for category in categorys %}
                                    <option value="{{ category }}">
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h2 class="text-lg font-bold mb-2">Nguyên Liệu</h2>
                                <div id="ingredients-container">
                                    <div class="mb-2 flex items-center">
                                        <input class="w-1/3 p-2 border rounded mr-2" type="text" name="ingredient_quantity[]" placeholder="250g"/>
                                        <input class="w-2/3 p-2 border rounded" name="ingredient_name[]" list="ingredients" placeholder="Chọn hoặc nhập nguyên liệu"/>
                                        <datalist id="ingredients">
                                            {% for ingredient in ingredients %}
                                                <option value="{{ ingredient }}">
                                            {% endfor %}
                                        </datalist>
                                        <button class="ml-2 text-red-500" onclick="removeElement(this)">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="text-blue-500" onclick="addIngredient()">+ Nguyên liệu</button>
                            </div>
                            <div>
                                <h2 class="text-lg font-bold mb-2">Các bước</h2>
                                <div class="mb-2">
                                    <label class="block text-gray-600">Thời gian nấu</label>
                                    <input class="w-full p-2 border rounded" type="number" name="cooking_time" placeholder="90 phút"/>
                                </div>
                                <div id="steps-container">
                                    <div class="mb-2 flex items-start">
                                        <span class="bg-gray-200 text-gray-600 rounded-full w-6 h-6 flex items-center justify-center mr-2">1</span>
                                        <div class="flex-1">
                                            <input class="w-full p-2 border rounded mb-2" type="text" name="step_description[]" placeholder="Trộn bột và nước đến khi đặc lại"/>
                                        </div>
                                        <button class="ml-2 text-red-500" onclick="removeElement(this)">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="text-blue-500" onclick="addStep()">+ Thêm bước</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Thêm input hidden để lưu dữ liệu JSON nếu cần -->
                <input type="hidden" name="ingredients" id="ingredients-data">
                <input type="hidden" name="steps" id="steps-data">
            </form>
        </div>
    {% endblock %}

    {% block jsblock %}
<script>
    // Lấy danh sách hợp lệ từ datalist
    const categoryOptions = Array.from(document.getElementById('categorys').options).map(option => option.value);
    const ingredientOptions = Array.from(document.getElementById('ingredients').options).map(option => option.value);

    console.log('Valid Categories:', categoryOptions);
    console.log('Valid Ingredients:', ingredientOptions);

    document.getElementById('recipeForm').addEventListener('submit', function(event) {
        // Thu thập dữ liệu
        const name = document.getElementById('name').value.trim();
        const description = document.getElementById('description').value.trim();
        const category = document.getElementById('recipeForm').querySelector('input[name="category"]').value.trim();
        const cookingTime = document.getElementById('recipeForm').querySelector('input[name="cooking_time"]').value;
        const image = document.getElementById('imageUpload').files[0];
    
        const ingredients = [];
        document.querySelectorAll('#ingredients-container .flex').forEach(div => {
            const quantity = div.querySelector('input[name="ingredient_quantity[]"]').value;
            const name = div.querySelector('input[name="ingredient_name[]"]').value;
            if (quantity && name) {
                ingredients.push({ quantity, name });
            }
        });
        //const ingredientsInput = document.getElementById('ingredients-data');
        //ingredientsInput.value = JSON.stringify(ingredients);
        //console.log('Ingredients:', ingredientsInput.value);

        // Thu thập các bước
        const steps = [];
        document.querySelectorAll('#steps-container .flex .flex-1').forEach(div => {
            const description = div.querySelector('input[name="step_description[]"]').value;
            if (description) {
                steps.push({ description });
            }
        });
        //const stepsInput = document.getElementById('steps-data');
        //stepsInput.value = JSON.stringify(steps);
        //console.log('Steps:', stepsInput.value);

        // Kiểm tra tính hợp lệ
        const errors = [];
        if (!name) errors.push("Tên món là bắt buộc.");
        if (!description) errors.push("Mô tả là bắt buộc.");
        if (!cookingTime) {
            errors.push("Thời gian nấu là bắt buộc.");
        } else if (isNaN(cookingTime) || parseInt(cookingTime) <= 0) {
            errors.push("Thời gian nấu phải là số nguyên dương.");
        }
        if (!category) {
            errors.push("Danh mục là bắt buộc.");
        } else if (!categoryOptions.includes(category)) {
            errors.push("Danh mục phải được chọn từ danh sách: ");
        }
        if (ingredients.length === 0) {
            errors.push("Phải có ít nhất một nguyên liệu.");
        } else {
            ingredients.forEach((item, index) => {
                if (!ingredientOptions.includes(item.name)) {
                    errors.push(`Nguyên liệu "${item.name}" ở vị trí ${index + 1} phải được chọn từ danh sách`);
                }
            });
        }
        if (steps.length === 0) {
            errors.push("Phải có ít nhất một bước.");
        }

        // Hiển thị lỗi nếu có
        const errorContainer = document.getElementById('error-messages');
        const errorList = document.getElementById('error-list');
        if (errors.length > 0) {
            event.preventDefault(); // Ngăn form gửi lên server
            errorList.innerHTML = ''; // Xóa lỗi cũ
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            errorContainer.classList.remove('hidden'); // Hiện thông báo lỗi
        } else {
            // Nếu hợp lệ, gán dữ liệu vào input hidden và gửi form
            document.getElementById('ingredients-data').value = JSON.stringify(ingredients);
            document.getElementById('steps-data').value = JSON.stringify(steps);
            errorContainer.classList.add('hidden'); // Ẩn thông báo lỗi
            // Form sẽ được gửi bình thường
        }
    });

    document.getElementById('imageUpload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('previewImage');
                img.src = e.target.result;
                img.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });
</script>
<!-- Truyền dữ liệu từ template sang JavaScript -->

<!-- Các script khác -->
<script src="{% static 'homepage/js/jquery/jquery-2.2.4.min.js' %}"></script>
<script src="{% static 'homepage/js/bootstrap/popper.min.js' %}"></script>
<script src="{% static 'homepage/js/bootstrap/bootstrap.min.js' %}"></script>
<script src="{% static 'homepage/js/plugins/plugins.js' %}"></script>
<script src="{% static 'homepage/js/active.js' %}"></script>
{% endblock %}