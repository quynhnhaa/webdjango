{% load static %}

<div class="chatbox-toggle">
    <button id="chatToggleBtn" class="btn delicious-btn" title="Chat v·ªõi bot ·∫©m th·ª±c">
        <i class="fa fa-comments" aria-hidden="true"></i>
    </button>
</div>

<div class="chatbox-wrapper" id="chatboxWrapper">
    <div class="chatbox-header">
        <h4>Chatbot ·∫®m Th·ª±c</h4>
        <button id="chatCloseBtn" class="chat-close-btn">
            <i class="fa fa-times" aria-hidden="true"></i>
        </button>
    </div>
    <div class="chatbox-messages" id="chatboxMessages">
        <div class="chat-message bot">
            <img src="{% static 'homepage/img/core-img/logo.png' %}" alt="Bot Avatar" class="avatar">
            <div class="message-content">
                Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay? H·ªèi t√¥i v·ªÅ c√¥ng th·ª©c, nguy√™n li·ªáu, ho·∫∑c g·ª£i √Ω m√≥n ƒÉn nh√©!
            </div>
        </div>
    </div>
    <div class="chat-input-area">
        <div class="emoji-picker">
            <button id="emojiBtn" class="emoji-toggle-btn">
                <i class="fa fa-smile-o" aria-hidden="true"></i>
            </button>
            <div class="emoji-menu" id="emojiMenu">
                <span class="emoji" data-emoji="üòä">üòä</span>
                <span class="emoji" data-emoji="üëç">üëç</span>
                <span class="emoji" data-emoji="üç¥">üç¥</span>
                <span class="emoji" data-emoji="ü•ó">ü•ó</span>
                <span class="emoji" data-emoji="üçú">üçú</span>
            </div>
        </div>
        <input type="text" id="chatInput" placeholder="Nh·∫≠p c√¢u h·ªèi v·ªÅ m√≥n ƒÉn..." autocomplete="off">
        <button id="sendMessage" class="btn delicious-btn">
            <i class="fa fa-paper-plane" aria-hidden="true"></i>
        </button>
    </div>
</div>

<link rel="stylesheet" href="{% static 'homepage/chatbox.css' %}">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function() {
        const chatboxWrapper = $('#chatboxWrapper');
        const chatToggleBtn = $('#chatToggleBtn');
        const chatCloseBtn = $('#chatCloseBtn');
        const chatboxMessages = $('#chatboxMessages');
        const chatInput = $('#chatInput');
        const sendButton = $('#sendMessage');
        const emojiBtn = $('#emojiBtn');
        const emojiMenu = $('#emojiMenu');

        // Hi·ªán/·∫©n chatbox 
        chatToggleBtn.on('click', function() {
            chatboxWrapper.toggle();
            if (chatboxWrapper.is(':visible')) {
                chatInput.focus();
                chatboxMessages.scrollTop(chatboxMessages[0].scrollHeight);
            }
        });

        chatCloseBtn.on('click', function() {
            chatboxWrapper.hide();
        });

        emojiBtn.on('click', function() {
            emojiMenu.toggle();
        });

        $('.emoji').on('click', function() {
            chatInput.val(chatInput.val() + $(this).data('emoji'));
            emojiMenu.hide();
            chatInput.focus();
        });

        $(document).on('click', function(e) {
            if (!$(e.target).closest('.emoji-picker').length) {
                emojiMenu.hide();
            }
        });

        // H√†m th√™m tin nh·∫Øn
        function appendMessage(sender, message) {
            const messageClass = sender === 'user' ? 'user' : 'bot';
            const avatar = sender === 'user' ? 
                '{% static "homepage/img/core-img/hamburger2.png" %}' : 
                '{% static "homepage/img/core-img/logo.png" %}';
            const messageHtml = `
                <div class="chat-message ${messageClass}">
                    ${sender === 'bot' ? `<img src="${avatar}" alt="${sender} Avatar" class="avatar">` : ''}
                    <div class="message-content">${message}</div>
                    ${sender === 'user' ? `<img src="${avatar}" alt="${sender} Avatar" class="avatar">` : ''}
                </div>
            `;
            chatboxMessages.append(messageHtml);
            chatboxMessages.scrollTop(chatboxMessages[0].scrollHeight);
        }

        // H√†m g·ª≠i tin nh·∫Øn
        function sendMessage() {
            const message = chatInput.val().trim();
            if (!message) return;

            appendMessage('user', message);
            chatInput.val('');

            $.ajax({
                url: '/api/chatbot',
                method: 'POST',
                data: JSON.stringify({ message: message }),
                contentType: 'application/json',
                success: function(response) {
                    const botResponse = response.reply || 'Xin l·ªói, t√¥i kh√¥ng hi·ªÉu c√¢u h·ªèi. H√£y th·ª≠ h·ªèi v·ªÅ m√≥n ƒÉn!';
                    appendMessage('bot', botResponse);
                },
                error: function() {
                    appendMessage('bot', 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
                }
            });
        }

        sendButton.on('click', sendMessage);

        chatInput.on('keypress', function(e) {
            if (e.which === 13) {
                sendMessage();
            }
        });

        $(document).ajaxSend(function(event, jqXHR, settings) {
            if (settings.url === '/api/chatbot') {
                const data = JSON.parse(settings.data);
                let reply = 'Xin l·ªói, t√¥i ch∆∞a c√≥ th√¥ng tin v·ªÅ c√¢u h·ªèi n√†y. H√£y h·ªèi v·ªÅ m√≥n ƒÉn kh√°c!';
                if (data.message.toLowerCase().includes('ph·ªü')) {
                    reply = 'Ph·ªü b√≤ c·∫ßn:<br>- X∆∞∆°ng b√≤: 1kg<br>- Th·ªãt b√≤: 500g<br>- B√°nh ph·ªü: 1kg<br>- H√†nh t√¢y, g·ª´ng, hoa h·ªìi, qu·∫ø<br>- Rau th∆°m<br>H·∫ßm x∆∞∆°ng 6-8 gi·ªù, n√™m gia v·ªã. Chi ti·∫øt h∆°n?';
                } else if (data.message.toLowerCase().includes('b√∫n ch·∫£')) {
                    reply = 'B√∫n ch·∫£ c·∫ßn:<br>- Th·ªãt l·ª£n: 500g<br>- B√∫n: 1kg<br>- N∆∞·ªõc m·∫Øm, t·ªèi, ·ªõt, chanh<br>- Rau s·ªëng<br>N∆∞·ªõng th·ªãt, pha n∆∞·ªõc ch·∫•m. H∆∞·ªõng d·∫´n chi ti·∫øt?';
                } else if (data.message.toLowerCase().includes('b√°nh x√®o')) {
                    reply = 'B√°nh x√®o c·∫ßn:<br>- B·ªôt g·∫°o: 200g<br>- N∆∞·ªõc c·ªët d·ª´a: 200ml<br>- T√¥m, th·ªãt: 200g<br>- Gi√° ƒë·ªó, rau s·ªëng<br>Chi√™n tr√™n ch·∫£o n√≥ng. Chi ti·∫øt h∆°n?';
                }
                jqXHR.done({ reply: reply });
                return false;
            }
        });
    });
</script>