{% load static %}

<div class="chatbox-toggle">
    <button id="chatToggleBtn" class="btn delicious-btn" title="Chat bot ·∫©m th·ª±c">
        <i class="fa fa-comments" aria-hidden="true"></i>
    </button>
</div>

<div class="chatbox-wrapper" id="chatboxWrapper">
    <div class="chatbox-header">
        <h4>Chatbot ·∫®m Th·ª±c</h4>
        <button id="chatCloseBtn" class="chat-close-btn">
            <i class="fa fa-times" aria-hidden="true"></i>
        </button>
    </div>
    <div class="chatbox-messages" id="chatboxMessages">
        <div class="chat-message bot">
            <img src="{% static 'homepage/img/core-img/logo.png' %}" alt="Bot Avatar" class="avatar">
            <div class="message-content">
                Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay? H·ªèi t√¥i v·ªÅ c√¥ng th·ª©c, nguy√™n li·ªáu, ho·∫∑c g·ª£i √Ω m√≥n ƒÉn nh√©!
            </div>
        </div>
    </div>
    <div class="chat-input-area">
        <div class="emoji-picker">
            <button id="emojiBtn" class="emoji-toggle-btn">
                <i class="fa fa-smile-o" aria-hidden="true"></i>
            </button>
            <div class="emoji-menu" id="emojiMenu">
                <span class="emoji" data-emoji="üòä">üòä</span>
                <span class="emoji" data-emoji="üëç">üëç</span>
                <span class="emoji" data-emoji="üç¥">üç¥</span>
                <span class="emoji" data-emoji="ü•ó">ü•ó</span>
                <span class="emoji" data-emoji="üçú">üçú</span>
            </div>
        </div>
        <input type="text" id="chatInput" placeholder="Nh·∫≠p c√¢u h·ªèi v·ªÅ m√≥n ƒÉn..." autocomplete="off">
        <button id="sendMessage" class="btn delicious-btn">
            <i class="fa fa-paper-plane" aria-hidden="true"></i>
        </button>
    </div>
</div>

<link rel="stylesheet" href="{% static 'homepage/chatbox.css' %}">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function() {
        const chatboxWrapper = $('#chatboxWrapper');
        const chatToggleBtn = $('#chatToggleBtn');
        const chatCloseBtn = $('#chatCloseBtn');
        const chatboxMessages = $('#chatboxMessages');
        const chatInput = $('#chatInput');
        const sendButton = $('#sendMessage');
        const emojiBtn = $('#emojiBtn');
        const emojiMenu = $('#emojiMenu');
        
        function generateUUID() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        let websocket;
        let currentBotMessageEl = null;
        const threadId = generateUUID(); // Random
        
        // K·∫øt n·ªëi WebSocket
        function connectWebSocket(){
            websocket = new WebSocket(`ws://localhost:5001/ws/${threadId}`);

            websocket.onmessage = function (event) {
                const data = event.data;

                if (currentBotMessageEl) {
                    currentBotMessageEl.append(data);
                    console.log(data);
                }
            };

            websocket.onerror = function () {
                appendMessage('bot', '‚ö†Ô∏è L·ªói k·∫øt n·ªëi Chatbot.');
            };

            websocket.onclose = function () {
                appendMessage('bot', 'üí¨ K·∫øt n·ªëi ƒë√£ ƒë√≥ng. ƒêang th·ª≠ l·∫°i...');
                setTimeout(connectWebSocket, 3000); // t·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i
            };
        }

        connectWebSocket();

        // Hi·ªán/·∫©n chatbox 
        chatToggleBtn.on('click', function() {
            chatboxWrapper.toggle();
            if (chatboxWrapper.is(':visible')) {
                chatInput.focus();
                chatboxMessages.scrollTop(chatboxMessages[0].scrollHeight);
            }
        });

        chatCloseBtn.on('click', function() {
            chatboxWrapper.hide();
        });

        emojiBtn.on('click', function() {
            emojiMenu.toggle();
        });

        $('.emoji').on('click', function() {
            chatInput.val(chatInput.val() + $(this).data('emoji'));
            emojiMenu.hide();
            chatInput.focus();
        });

        $(document).on('click', function(e) {
            if (!$(e.target).closest('.emoji-picker').length) {
                emojiMenu.hide();
            }
        });

        // H√†m th√™m tin nh·∫Øn
        function appendMessage(sender, message, returnElement = false) {
            const messageClass = sender === 'user' ? 'user' : 'bot';
            const avatar = sender === 'user' ?
                '{% static "homepage/img/core-img/hamburger2.png" %}' :
                '{% static "homepage/img/core-img/logo.png" %}';
            const messageId = 'msg-' + Date.now(); // ho·∫∑c UUID n·∫øu c·∫ßn
            const messageHtml = `
                <div class="chat-message ${messageClass}" data-id="${messageId}">
                    ${sender === 'bot' ? `<img src="${avatar}" alt="${sender} Avatar" class="avatar">` : ''}
                    <div class="message-content" id="${messageId}">${message}</div>
                    ${sender === 'user' ? `<img src="${avatar}" alt="${sender} Avatar" class="avatar">` : ''}
                </div>
            `;
            chatboxMessages.append(messageHtml);
            chatboxMessages.scrollTop(chatboxMessages[0].scrollHeight);

            if (returnElement) {
                return $('#' + messageId); // Tr·∫£ l·∫°i ph·∫ßn t·ª≠ message-content ƒë·ªÉ stream ti·∫øp
            }
        }

        // H√†m g·ª≠i tin nh·∫Øn
        function sendMessage() {
            const message = chatInput.val().trim();
            if (!message || websocket.readyState !== WebSocket.OPEN) return;

            appendMessage('user', message);
            chatInput.val('');

            // G·ª≠i tin nh·∫Øn
            websocket.send(message);

            // T·∫°o khung tin nh·∫Øn bot r·ªóng ƒë·ªÉ stream v√†o
            currentBotMessageEl = appendMessage('bot', '', true); // <- Quan tr·ªçng!
        }

        sendButton.on('click', sendMessage);

        chatInput.on('keypress', function(e) {
            if (e.which === 13) {
                sendMessage();
            }
        });
    });
</script>